# 公众号数据管理功能配置指南

## 环境变量配置

⚠️ **重要安全更新**：为了提高安全性，API密钥现在仅在服务端使用，不再暴露到客户端。

在 `.env` 文件中配置以下环境变量：

```env
# 公众号API基础URL配置（仅服务端使用）
WECHAT_API_BASE_URL=http://127.0.0.1:8010

# 公众号API密钥（仅服务端使用）
WECHAT_API_KEY=your_actual_api_key_here
```

**⚠️ 安全说明**：
- 移除了 `NEXT_PUBLIC_` 前缀，确保敏感信息不会被打包到客户端
- 所有微信API请求现在通过Next.js API路由代理，提供JWT Token身份验证
- 用户必须先登录才能访问微信API功能

## 功能特性

### ✅ 已实现功能

1. **公众号列表展示**
   - 卡片式展示公众号信息
   - 支持认证状态、客户类型等标签显示
   - 显示文章统计信息

2. **搜索和筛选**
   - 关键词搜索（名称、描述、标识）
   - 按认证状态筛选（已认证/未认证）
   - 实时搜索结果更新

3. **无限滚动加载**
   - 基于 IntersectionObserver API
   - 自动检测滚动到底部并加载更多数据
   - 优化的性能表现

4. **CRUD 操作**
   - ✅ **创建公众号**: 支持通过公众号 BIZ 标识符创建
   - ✅ **查看详情**: 完整的公众号信息展示
   - ✅ **编辑更新**: 修改公众号名称和描述
   - ✅ **删除确认**: 带二次确认的安全删除

5. **响应式设计**
   - 适配不同屏幕尺寸
   - 移动端优化的布局

## API 集成

### 🛡️ 安全架构

采用三层安全架构确保API安全性：

```
客户端 → Next.js API代理 → 微信API服务
  ↓         ↓               ↓
JWT Token  验证+转发       API KEY
```

### HTTP 客户端配置

**客户端HTTP客户端** (`src/utils/wechat-http.ts`) 特性：
- 使用JWT Token进行身份验证（`Authorization: Bearer token`）
- 调用本地API代理路由（`/api/wechat/*`）
- 统一的错误处理
- 支持查询参数自动编码
- 完整的 RESTful 方法支持

**服务端HTTP客户端** (`src/utils/wechat-server-http.ts`) 特性：
- 仅在API路由中使用
- 自动添加 `X-Api-Key` 请求头
- 直接与微信API服务通信
- 完整的错误处理和日志记录

### 服务层架构

公众号服务 (`src/services/wechat.ts`) 提供的方法：
- `getAccounts()` - 获取公众号列表
- `getAccountDetail()` - 获取公众号详情
- `createAccount()` - 创建公众号
- `updateAccount()` - 更新公众号
- `deleteAccount()` - 删除公众号
- `searchAccounts()` - 搜索公众号

## 组件架构

### 核心组件

1. **WechatAccountCard** - 公众号卡片组件
   - 显示公众号基本信息
   - 集成操作按钮（查看、编辑、删除）
   - 支持加载状态

2. **WechatAccountForm** - 表单组件
   - 支持创建和编辑模式
   - 表单验证和错误处理
   - 响应式布局

3. **WechatAccountDetail** - 详情组件
   - 完整信息展示
   - 分类信息组织
   - 进度条和统计信息

### 自定义 Hook

**useWechatAccounts** - 状态管理 Hook:
- 数据获取和缓存
- 无限滚动逻辑
- CRUD 操作状态管理
- 错误处理和用户反馈

## 使用说明

### 1. 配置 API 密钥

将 `.env` 文件中的 `NEXT_PUBLIC_WECHAT_API_KEY` 替换为实际的 API 密钥。

### 2. 启动后端服务

确保公众号 API 服务运行在配置的地址上（默认: `http://127.0.0.1:8001`）。

### 3. 访问页面

访问 `/crawler-data/wechat` 页面开始使用公众号管理功能。

### 4. 基本操作流程

1. **创建公众号**：点击"创建公众号"按钮，输入公众号 BIZ 标识符和其他信息
2. **搜索筛选**：使用搜索框和筛选器查找特定公众号
3. **查看详情**：点击卡片上的"查看详情"按钮
4. **编辑信息**：点击"编辑"按钮修改公众号信息
5. **删除公众号**：点击"删除"按钮并确认删除操作

#### 如何获取公众号 BIZ

公众号 BIZ 是公众号的唯一标识符，可以通过以下方式获取：

1. **从文章链接获取**：
   - 公众号文章 URL 格式：`https://mp.weixin.qq.com/s?__biz=MzA3MDU2NTYzMg==&mid=...`
   - BIZ 即为 `__biz` 参数的值：`MzA3MDU2NTYzMg==`

2. **从公众号分享链接获取**：
   - 分享链接中包含 `__biz` 参数

3. **使用开发者工具**：
   - 在微信开发者工具中查看公众号信息

## 技术特性

### 性能优化

- **虚拟滚动**: 大列表性能优化
- **按需加载**: 分页加载减少初始加载时间
- **缓存机制**: 本地状态缓存减少重复请求
- **防抖搜索**: 减少搜索请求频率

### 用户体验

- **加载状态**: 完善的加载指示器
- **错误处理**: 友好的错误提示
- **确认对话框**: 重要操作二次确认
- **响应式设计**: 适配各种设备

### 代码质量

- **TypeScript**: 完整的类型定义
- **组件复用**: 高度模块化的组件设计
- **错误边界**: 健壮的错误处理机制
- **最佳实践**: 遵循 React 和 Ant Design 最佳实践

## 故障排除

### 常见问题

1. **API 连接失败**
   - 检查 `NEXT_PUBLIC_WECHAT_API_BASE_URL` 配置
   - 确认后端服务正在运行
   - 验证网络连接

2. **认证失败**
   - 检查 `NEXT_PUBLIC_WECHAT_API_KEY` 是否正确
   - 确认 API 密钥具有相应权限

3. **数据加载异常**
   - 查看浏览器控制台错误信息
   - 检查 API 响应格式是否匹配

### 调试技巧

- 开启浏览器开发者工具网络面板查看 API 请求
- 查看控制台日志获取详细错误信息
- 使用 React DevTools 检查组件状态
